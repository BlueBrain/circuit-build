# create dag images using `snakemake --dag`
SHELL = /bin/bash -eu
SELF_DIR = $(dir $(lastword $(MAKEFILE_LIST)))
BASE_DIR = $(SELF_DIR)/..
OUT_DIR = $(BASE_DIR)/doc/source/dag
BIONAME = $(BASE_DIR)/tests/proj66-tiny/
SNAKEFILE = $(BASE_DIR)/snakemake/Snakefile
SM = snakemake --snakefile $(SNAKEFILE) --config bioname=$(BIONAME) --dag --

dag:
	mkdir -p subcellular  # needed for subcellular rule
	mkdir -p $(OUT_DIR)
	$(SM) functional > $(OUT_DIR)/functional.dot
	$(SM) structural > $(OUT_DIR)/structural.dot
	$(SM) functional_sonata > $(OUT_DIR)/functional_sonata.dot
	$(SM) structural_sonata > $(OUT_DIR)/structural_sonata.dot
	$(SM) spatial_index_segment > $(OUT_DIR)/spatial_index_segment.dot
	$(SM) subcellular > $(OUT_DIR)/subcellular.dot
	$(SM) assign_emodels > $(OUT_DIR)/assign_emodels.dot
	rmdir -p subcellular
	# useful for debug or inspection
	for var in $(OUT_DIR)/*.dot; do dot -Tsvg -o$${var%.dot}.svg $$var; done
