# create graphs using snakemake
SHELL = /bin/bash -eu
SELF_DIR = $(dir $(lastword $(MAKEFILE_LIST)))
BASE_DIR = $(SELF_DIR)/..
OUT_DIR = $(BASE_DIR)/doc/build/graphs
BIONAME = $(BASE_DIR)/tests/proj66-tiny/
BIONAME_SYNTH = $(BASE_DIR)/tests/proj66-tiny-synth/
SNAKEFILE = $(BASE_DIR)/snakemake/Snakefile
SM = snakemake --snakefile $(SNAKEFILE) --config bioname=$(BIONAME) --cluster-config $(BIONAME)/cluster.yaml
SM_SYNTH = snakemake --snakefile $(SNAKEFILE) --config bioname=$(BIONAME_SYNTH) --cluster-config $(BIONAME_SYNTH)/cluster.yaml
TARGETS = functional structural spatial_index_segment subcellular assign_emodels
GRAPH = filegraph

graphs:
	rm -Rvf $(OUT_DIR)
	mkdir -p $(OUT_DIR)
	mkdir -p subcellular  # needed for subcellular rule
	for target in $(TARGETS); do \
	    $(SM) --$(GRAPH) -- $${target} > $(OUT_DIR)/$${target}.dot ; \
	done
	$(SM_SYNTH) --$(GRAPH) -- functional > $(OUT_DIR)/functional_synth.dot
	$(SM_SYNTH) --$(GRAPH) -- structural > $(OUT_DIR)/structural_synth.dot
	rmdir -p subcellular
	# convert all the dot files to svg
	for var in $(OUT_DIR)/*.dot; do dot -Tsvg -o$${var%.dot}.svg $$var; done
